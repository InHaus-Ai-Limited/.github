name: "Terraform"

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  checks:
    name: "Lint"
    concurrency: ci-${{ github.ref }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        terraform_workspace: ["staging", "production"]
    steps:
      - uses: InHaus-AI-Limited/.github/workflows/terraform/lint.yml@main
        with:
          terraform_workspace: ${{ matrix.terraform_workspace }}
          terraform_version: ${{ inputs.terraform_version }}
          github_token: ${{ secrets.github_token }}
      - uses: InHaus-AI-Limited/.github/workflows/terraform/checkov.yml@main
        with:
          terraform_workspace: ${{ matrix.terraform_workspace }}
          terraform_version: ${{ inputs.terraform_version }}
          github_token: ${{ secrets.github_token }}

  plan:
    name: "Plan"
    concurrency: ci-${{ github.ref }}
    needs: [checks]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        terraform_workspace: ["staging", "production"]
    steps:
      - uses: InHaus-AI-Limited/.github/workflows/terraform/plan.yml@main
        with:
          terraform_workspace: ${{ matrix.terraform_workspace }}
          terraform_version: ${{ inputs.terraform_version }}
          github_token: ${{ secrets.github_token }}

  apply_staging:
    name: "Apply Staging"
    needs: [plan]
    concurrency: staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: InHaus-AI-Limited/.github/workflows/terraform/apply.yml@main
        with:
          terraform_workspace: "staging"
          terraform_version: ${{ inputs.terraform_version }}
          github_token: ${{ secrets.github_token }}

  apply_production:
    name: "Apply Production"
    needs: [plan]
    concurrency: production
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: InHaus-AI-Limited/.github/workflows/terraform/apply.yml@main
        with:
          terraform_workspace: "production"
          terraform_version: ${{ inputs.terraform_version }}
          github_token: ${{ secrets.github_token }}
